<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CHO INDEXING ‚Äì Retrieve & Full Edit</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background: #f4f6f8; padding: 20px; }
h2 { text-align: center; }
form { max-width: 650px; margin:auto; background:#fff; padding:25px; border-radius:10px; box-shadow:0 5px 20px rgba(0,0,0,.1); }
input, select, button { width:100%; padding:10px; margin-top:10px; }
button { border:none; cursor:pointer; font-weight:bold; }
#retrieveBtn { background:#1e88e5; color:#fff; }
#updateBtn { background:#2ecc71; color:#fff; }
#downloadPDFBtn { background:#4caf50; color:#fff; display:none; }
#passportPreview img { max-width:120px; border-radius:8px; margin-top:10px; box-shadow:0 4px 15px rgba(0,0,0,0.15);}
</style>
</head>
<body>

<h2>CHO INDEXING ‚Äì RETRIEVE & FULL EDIT DATA</h2>

<form id="indexForm">
  <!-- Retrieval -->
  <input name="surname" placeholder="SURNAME" required>
  <select name="bloodgroup" required>
    <option value="">SELECT BLOOD GROUP</option>
    <option>A+</option><option>A-</option>
    <option>B+</option><option>B-</option>
    <option>AB+</option><option>AB-</option>
    <option>O+</option><option>O-</option>
  </select>
  <select name="olevel_type" required>
    <option value="">SELECT O-LEVEL TYPE</option>
    <option>WAEC</option><option>NECO</option><option>NABTEB</option>
    <option>WAEC / WAEC</option><option>NECO / NECO</option><option>NABTEB / NABTEB</option>
    <option>WAEC / NECO</option><option>NABTEB / WAEC</option><option>NABTEB / NECO</option>
  </select>
  <button type="button" id="retrieveBtn">üîç RETRIEVE MY RECORD</button>

  <hr>

  <!-- Editable -->
  <input name="firstname" placeholder="FIRSTNAME">
  <input name="othernames" placeholder="OTHERNAMES">
  <select name="gender">
    <option value="">SELECT GENDER</option><option>MALE</option><option>FEMALE</option>
  </select>
  <input name="state" placeholder="STATE">
  <input name="lga_city_town" placeholder="LGA / CITY/TOWN">
  <label>DATE OF BIRTH</label>
  <input type="date" name="dob">

  <label>UPLOAD NEW PASSPORT (Optional, JPG/PNG max 5MB)</label>
  <input type="file" id="passport">
  <div id="passportPreview"></div>

  <input name="olevel_year" placeholder="O-LEVEL YEAR(S)">
  <input name="olevel_exam" placeholder="O-LEVEL EXAM NUMBER">
  <input name="alevel_type" placeholder="A-LEVEL TYPE">
  <input name="alevel_year" placeholder="A-LEVEL YEAR">

  <input id="engGrade" placeholder="ENGLISH GRADE">
  <select id="engBody"><option>WAEC</option><option>NECO</option><option>NABTEB</option></select>
  <input id="mathGrade" placeholder="MATHEMATICS GRADE">
  <select id="mathBody"><option>WAEC</option><option>NECO</option><option>NABTEB</option></select>
  <input id="bioGrade" placeholder="BIOLOGY GRADE">
  <select id="bioBody"><option>WAEC</option><option>NECO</option><option>NABTEB</option></select>
  <input id="chemGrade" placeholder="CHEMISTRY GRADE">
  <select id="chemBody"><option>WAEC</option><option>NECO</option><option>NABTEB</option></select>
  <input id="phyGrade" placeholder="PHYSICS GRADE">
  <select id="phyBody"><option>WAEC</option><option>NECO</option><option>NABTEB</option></select>

  <input name="remarks" placeholder="REMARKS">

  <button type="submit" id="updateBtn" disabled>‚úÖ UPDATE MY INFORMATION</button>
  <button type="button" id="downloadPDFBtn">üìÑ DOWNLOAD MY SLIP (PDF)</button>
</form>

<script>
document.addEventListener("DOMContentLoaded", () => {
const SHEETBEST_URL = "https://api.sheetbest.com/sheets/ceb9eddc-af9a-473a-9a32-f52c21c7f72b";
const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dpsbwjw83/image/upload";
const CLOUDINARY_PRESET = "cho_passports";

const form = document.getElementById("indexForm");
const retrieveBtn = document.getElementById("retrieveBtn");
const updateBtn = document.getElementById("updateBtn");
const downloadPDFBtn = document.getElementById("downloadPDFBtn");
const passportInput = document.getElementById("passport");
const previewContainer = document.getElementById("passportPreview");

let recordId = null;
let recordData = null;

// Format DOB
function formatDOB(d){ if(!d) return ""; const x=new Date(d); return `${String(x.getDate()).padStart(2,"0")}/${String(x.getMonth()+1).padStart(2,"0")}/${x.getFullYear()}`; }

// 1Ô∏è‚É£ Retrieve Record
retrieveBtn.onclick = async () => {
  const surname = form.surname.value.trim().toUpperCase();
  const blood = form.bloodgroup.value;
  const olevel = form.olevel_type.value;
  if(!surname||!blood||!olevel){ alert("Complete all fields"); return; }

  try{
    const res = await fetch(SHEETBEST_URL);
    const data = await res.json();
    const found = data.find(r=>r.SURNAME===surname && r.BLOOD_GROUP===blood && r.OLEVEL_TYPE===olevel);
    if(!found){ alert("‚ùå Record not found"); return; }
    recordId = found.id; recordData = found;

    // Fill form
    Object.keys(found).forEach(k=>{
      if(form[k]) form[k].value = found[k];
    });

    updateBtn.disabled = false;
    downloadPDFBtn.style.display="block";
    alert("‚úÖ Record retrieved successfully");

    // Preview existing passport
    if(found.PASSPORT){
      previewContainer.innerHTML = `<img src="${found.PASSPORT}" alt="Passport">`;
    }

  }catch(err){ console.error(err); alert("Failed to retrieve"); }
};

// 2Ô∏è‚É£ Passport upload + previous deletion
passportInput.addEventListener("change", async ()=>{
  if(!recordData){ alert("Retrieve record first"); passportInput.value=""; return; }
  const file = passportInput.files[0];
  if(!file) return;
  if(!["image/jpeg","image/png"].includes(file.type)){ alert("Only JPG/PNG"); passportInput.value=""; return; }
  if(file.size>5*1024*1024){ alert("Max 5MB"); passportInput.value=""; return; }

  previewContainer.innerHTML = `<img src="${URL.createObjectURL(file)}">`;

  try{
    // Upload new
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", CLOUDINARY_PRESET);
    const res = await fetch(CLOUDINARY_URL,{method:"POST",body:formData});
    const data = await res.json();
    if(!data.secure_url) throw "Upload failed";

    // Delete previous via serverless endpoint
    if(recordData.PASSPORT_PUBLIC_ID){
      await fetch("/api/delete-passport", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ public_id:recordData.PASSPORT_PUBLIC_ID, secret:"CHO_DELETE_SECRET" })
      });
    }

    recordData.PASSPORT = data.secure_url;
    recordData.PASSPORT_PUBLIC_ID = data.public_id;
    alert("‚úÖ Passport updated, previous deleted if existed");

  }catch(err){ console.error(err); alert("Passport upload failed"); }
});

// 3Ô∏è‚É£ Update Record
form.onsubmit = async e=>{
  e.preventDefault();
  if(!recordId) return;

  const payload = {
    SURNAME: form.surname.value.trim().toUpperCase(),
    BLOOD_GROUP: form.bloodgroup.value,
    OLEVEL_TYPE: form.olevel_type.value,
    FIRSTNAME: form.firstname.value,
    OTHERNAMES: form.othernames.value,
    GENDER: form.gender.value,
    STATE: form.state.value,
    LGA_CITY_TOWN: form.lga_city_town.value,
    DATE_OF_BIRTH: formatDOB(form.dob.value),
    OLEVEL_YEAR: form.olevel_year.value,
    OLEVEL_EXAM_NUMBER: form.olevel_exam.value,
    ALEVEL_TYPE: form.alevel_type.value,
    ALEVEL_YEAR: form.alevel_year.value,
    ENGLISH: `${engGrade.value} (${engBody.value})`,
    MATHEMATICS: `${mathGrade.value} (${mathBody.value})`,
    BIOLOGY: bioGrade.value?`${bioGrade.value} (${bioBody.value})`:"",
    CHEMISTRY: chemGrade.value?`${chemGrade.value} (${chemBody.value})`:"",
    PHYSICS: phyGrade.value?`${phyGrade.value} (${phyBody.value})`:"",
    REMARKS: form.remarks.value,
    PASSPORT: recordData.PASSPORT,
    PASSPORT_PUBLIC_ID: recordData.PASSPORT_PUBLIC_ID
  };

  try{
    await fetch(`${SHEETBEST_URL}/${recordId}`, {
      method:"PATCH",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    alert("‚úÖ Information updated successfully");
  }catch(err){ console.error(err); alert("Update failed"); }
};

// 4Ô∏è‚É£ Download PDF
downloadPDFBtn.onclick = ()=>{
  if(!recordData) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 20;
  doc.setFontSize(16);
  doc.text("CHO INDEXING SLIP", 105, y, {align:"center"}); y+=10;

  Object.entries(recordData).forEach(([k,v])=>{
    if(v && k!=="PASSPORT_PUBLIC_ID"){
      doc.setFontSize(11);
      doc.text(`${k.replace(/_/g," ")}: ${v}`,15,y);
      y+=7;
      if(y>280){ doc.addPage(); y=20; }
    }
  });

  doc.save(`CHO_${recordData.SURNAME}_SLIP.pdf`);
};
});
</script>

</body>
</html>